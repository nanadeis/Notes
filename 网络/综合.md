# 输入ping IP后敲回车，发包前会发生什么  
首先根据目的IP和路由表决定走哪个网卡，再根据网卡的子网掩码地址判断目的IP是否在子网内。ping目标ip时，如果在相同网段直接先查询arp缓存，如果找到目标ip的mac地址，直接发送出去，如果缓存中查不到，则从相同网段的网卡发arp问目标ip的mac地址，拿到mac地址后发送出去。如果不在主机的网段里，会查询默认网关ip，接着查询arp缓存，是否有网关的mac地址记录，如果有，填充该mac地址，发送出去，如果没有，发arp问网关的mac地址，得到结果，发送出去。同时mac地址也会被arp缓存起来。  

#  浏览器输入网址打开一个网页会经历哪些过程？  
1. 浏览器解析出域名，然后通过DNS查询这个域名的IP地址  
**域名解析**：通过读取配置文件获得DNS服务器的IP地址，然后将控制权传给内核的UDP模块。UDP模块将DNS查询报文封装成UDP报文，并将源端口、目的端口加入UDP数据包头部。然后UDP模块调用IP服务。IP模块则将UDP报文封装成IP数据报，并将源端、目的端IP地址加入IP数据报头部。接下来IP模块查询路由表以决定如何发送该IP数据报（主机在同一子网还是发给默认网关）。   
**ARP解析**如果ARP缓存中有目标IP的mac地址，则直接发。如果没有则广播ARP请求（以太网帧）,拿到Mac地址后发出去，同时将该地址缓存起来。  
2. 浏览器获得端口号  
3. 浏览器发起到ip：端口的连接  
TCP三次握手  
4. 浏览器向服务器发送一条HTTP请求报文  
5. 浏览器从服务器读取HTTP响应报文  
6. 浏览器关闭连接  




# 网卡收到数据包  
1. 网卡将数据包通过DMA的方式写入指定的内存地址，该地址由网卡驱动分配并初始化   
2. 网卡通过硬件中断（IRQ）通知CPU数据来了  
3. CPU根据中断表调用已经注册的中断函数，这个中断函数会调到驱动程序中相应的函数   
4. 驱动先禁用网卡的中断，表示驱动程序已经知道内存中有数据了，告诉网卡下次再收到数据包接收内存就可以了，不要再通知CPU了，这样可以提高效率，避免CPU不停的被中断  
5. 启动软中断。这步结束后，硬件中断处理函数就结束返回了。由于硬中断处理程序执行的过程中不能被中断，所以如果它执行的时间过长，会导致cPU没法响应其它硬件的中断，于是内核引入软中断，这样可以将硬中断处理函数耗时的部分移到软中断处理函数里面慢慢处理   
6. 内核中的ksoftirqd进程专门负责软中断的处理，当它收到软中断后，就会调用相应软中断所对应的处理函数。对于上面的网卡驱动模块抛出的软中断，ksoftirqd会调用网络模块的net_rx_action函数   
7. net_rx_action调用网卡驱动里的poll函数来一个一个的处理数据包   
8. 在pool函数中，驱动会一个接一个的读取网卡写到内存中的数据包，内存中数据包的格式只有驱动知道  
9. 驱动程序将内存中的数据包转换成内核网络模块能识别的skb格式，然后调用napi_gro_receive函数  
10. napi_gro_receive会处理GRO相关的内容【offload， 将本该操作系统进行的一些数据包处理，如分片，重组等，放到网卡硬件中去做】...
...
调用协议栈相应的函数，将数据包交给协议栈处理  
待内存中的所有数据包被处理完成后，启动网卡的硬中断，这样下次网卡再收到数据的时候就会通知CPU  

